<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Notifications WebSocket</title>

    <script src="resources/js/sockjs-0.3.4.js"></script>
    <script src="resources/js/stomp.js"></script>

    <script src="resources/js/jquery-1.12.2.min.js"></script>
    <script src="resources/js/toastr.min.js"></script>
    <link href="resources/js/toastr.min.css" rel="stylesheet"/>
    <script src="resources/js/stomp.js"></script>

    <script type="text/javascript">

        let stompClient = null;

        function setConnected(connected) {
            document.getElementById('status').innerHTML = connected?'✅':'❌';
        }

        function connect() {
            setConnected(false);
            const socket = new SockJS('/task');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                setConnected(true);
                stompClient.subscribe('/topic/task-status', function (taskStatusResponse) {
                    const taskStatus = JSON.parse(taskStatusResponse.body);
                    if (taskInProgressUuids.indexOf(taskStatus.uuid)<0) {
                        console.log("Ignoring status (not for me): ", taskStatus)
                        return;
                    }

                    logOnScreen("Got response: " + taskStatusResponse.body);
                    toastr.success("OK");
                });
            }, function() {
                setConnected(false);
                stompClient = null;
            });
        }

        var taskInProgressUuids = [];

        setInterval(p=> {if (stompClient == null) connect()}, 1000); // TODO debate: what number to use here?


        function sendViaRest() {
            const task = document.getElementById('task').value;

            // Option1: send via REST
            fetch("submit-task", {
                method: 'post',
                body: task
            })
                .then(response => response.text())
                .then(uuid => {
                    logOnScreen(`Requested task: ${task}. Got from server uuid=${uuid}`);
                    taskInProgressUuids.push(uuid);
                })
                .catch(function (error) {
                    console.log('Request failed', error);
                });
        }
        function sendViaWS() {
            const task = document.getElementById('task').value;

            // Option2: send via WS
            let uuid = uuidv4(); // generate unique id
            let body = JSON.stringify({'uuid': uuid, 'task': task});
            logOnScreen("Sending STOMP message: " + body);
            stompClient.send("/app/task", {}, body);
            taskInProgressUuids.push(uuid);
        }

        function logOnScreen(s) {
            const response = document.getElementById('response');
            const p = document.createElement('p');
            p.style.wordWrap = 'break-word';
            p.appendChild(document.createTextNode(s));
            response.appendChild(p);
        }


        function uuidv4() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }
        function generateTask() {
            // document.getElementById('task').value = uuidv4();
        }
    </script>

</head>

<body onload="generateTask(); connect();">

<div>
    Connected: <span id="status">✅</span>

    <div>
        <input type="text" id="task" value="task" />
        <button  autofocus onclick="sendViaRest()">Send via REST</button>
        <button onclick="sendViaWS()">Send via WS</button>
    </div>
    <br/>
    <p id="response"></p>
</div>
</body>
</html>